{% extends 'baseMap.html.twig' %}


{% block title %}BALISES{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href='https://api.mapbox.com/mapbox.js/v3.2.0/mapbox.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin="" />

    <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css" />

    <style type="text/css">
        #map{ /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
            height: 100%;
        }

        .sidenav
        {
            background-color: #FFEC02;
        }



        #map

        {
            z-index: 0;
            width:100%;
        }

        #selectplacetitle
        {
            position: absolute;
            top: 60%;
            left: 7%;
            z-index: 1;
            color: black;
            font-size: 80px;

        }


        #selectplacetitle h1
        {
            font-size: 80%;
            font-weight: bold;
        }

        #selectplacetitle span
        {
            color: white;
            font-weight: bold;
        }

        #logoonmap
        {
            position: absolute;
            bottom: 40px;
            right: 2px;
            z-index: 1;
            transform: scale(0.7, 0.7);
        }



        .popupCustom .leaflet-popup-tip
        {
            display: none;
        }

        .popupCustom .leaflet-popup-content-wrapper {
            box-shadow : none;
            background: none;
            color: white;
            height: 800px;
            width: 1000px;
        }

        .jumbotron
        {
            padding: 2%;
        }

        .bulleInfo
        {
            font-size: x-small;
            width: 55%;
            background: none;
            /*background: red;*/
            display: none;
            z-index: 2;
            position: fixed;
            bottom: -50%;



        }

        .bulleInfo1
        {
            background-color: rgba(0, 0, 0, 0);
            /*background-color: grey;*/
            background-image: url("{{ asset('uploads/ticket-balises.png') }}");
            background-size: cover;
            background-repeat: no-repeat;
            color: white;
            height: 30vh;
            width: 32vw;

        }

        .bulleInfo2
        {

        }

        .bulleInfo3
        {

            background-color: black;
            color: white;

            /*border-style: solid;*/
            border-color: black;
            overflow: scroll;
            border-radius: 10px;
            margin-top: 5%;
            font-size: 4px;
            height: 30vh;
            width: 32vw;
        }

        /* width */
        .bulleInfo3::-webkit-scrollbar
        {
            width: 20px;
        }

        /* Handle */
        .bulleInfo3::-webkit-scrollbar-thumb {
            background: yellow;
            border-radius: 10px;

        }


        .bulleInfo4
        {

        }

        .bulleInfo5
        {

        }

        .bulleInfo6 {
            background-color: grey;
            color: white;
            height: 250px;

            overflow: scroll;
            border-radius: 10px;
        }
        /* width */
        .bulleInfo6::-webkit-scrollbar
        {
            width: 20px;
        }

        /* Handle */
        .bulleInfo6::-webkit-scrollbar-thumb {
            background: yellow;
            border-radius: 10px;
        }
        }

        .bulleInfo1Photo
        {
            max-width: 100%;
        }

        .jumbotron h1
        {
            font-size: 20px;
        }

        .jumbotron p
        {
            font-size: 15px;
        }


    </style>
{% endblock %}



{% block body %}




    <div class="popupCustom" id="map">
    </div>



    <div id="selectplacetitle" style="display: block">
        <img id="jumelles" style="max-width: 80px" src="{{ asset('uploads/jumelles.png') }}">
        <h1>SÉLECTIONNER<br>VOTRE <span>LIEU</span></h1>
    </div>



    <div id="logoonmap">
        <a href="{{ path('home') }}"><img src="http://www.balises-theatres.com/img/Logo_balises_rond.png"/></a>
    </div>



    <!-- Info Bulle -->

    {% for theater in theaters %}

        <div class="bulleInfo" id="theater{{ theater.id }}">
            <div class="container-fluid">
                <div class="row bulleinfo">



                    <div class="col-12">
                        <div class="jumbotron bulleInfo1">
                            <img src="{{ asset('uploads/'~ theater.logo )}}" alt="" style="max-height: 120px;display: block; margin-left: auto; margin-right: 5%; padding-bottom: 5%; margin-top: 1%">
                            <h1 style="color : Yellow; text-align: right; margin-right: 10%; line-height: 3%; font-size: 20px" class="display-4">{{ theater.name }}</h1>
                            <p class="lead" style="text-align: right; margin-right: 10%; font-size: 20px">{{ theater.address1 }}<br>{{  theater.zipcode }} {{ theater.city }}<br>{{ theater.phoneNumber }}</p>
                        </div>

                    </div>

{#                    <div class="col-2">#}
{#                        <div class="bulleInfo2">#}

{#                        </div>#}
{#                    </div>#}

                    <div class="col-12">
                        <div class="jumbotron bulleInfo3">
                            <a href="{{ theater.website }}" target="_blank" ><h1 style="color : Yellow; font-weight: bold" class="display-4">{{ theater.name }}</h1></a>

                            <hr style="background-color : white; text-align : center; line-height: 1;";>
                            <h3 style="color : white; font-weight: bold" >CHOIX DE VOTRE SPECTACLE</h3>

                            {% for spectacle in spectacles %}
                                {% if spectacle.theater == theater %}
                                    <input type="radio" name="checkbox" id="checkbox" onchange="showDates({{ spectacle.id }})">
                                    <a href="{{ path('detailSpectacle', {"id": spectacle.id}) }}" target="_blank" for="checkbox" style="font-size: 20px; color: white">{{ spectacle.title }}</a>
                                    <p style="margin-top: 0%">{{ spectacle.distribution }}</p>


                                {% endif %}
                            {% endfor %}


                        </div>
                    </div>

{#                    <div class="col-5">#}
{#                        #}{#                        <div class="bulleInfo4">#}
{#                        #}{#                            <a href="{{ theater.website }}" target="_blank" ><img src="{{ asset('uploads/'~ theater.picture )}}" style="width: 250px; padding-bottom: 5%;float: right"></a>#}
{#                        #}{#                        </div>#}
{#                    </div>#}

{#                    <div class="col-2">#}
{#                        <div class="bulleInfo5">#}

{#                        </div>#}
{#                    </div>#}

                    <div class="col-12">
                        {% for show in theater.shows %}
                            <div class="jumbotron bulleInfo6" id="{{ show.id }}" style="display: none">

                                <h3 style="color : white; font-weight: bold; margin-left: 3%; text-align:center;" >SÉLÉCTIONNEZ LA DATE DE VOTRE SPECTACLE</h3>


                                {% for showdate in show.showDates %}
                                    <div>
                                        <input type="radio" name="radio" id="radio">
                                        <label for="radio" class="lead">{{ showdate.dateShow |localizeddate('none', 'none', app.request.locale, null, 'EEEE d MMMM Y') }} à {{ showdate.dateShow |date("H") }}h{{ showdate.dateShow |date("m") }}</label>
                                    </div>
                                {% endfor %}
                                <a class="btn btn-dark" style="-webkit-border-radius: 5px;-moz-border-radius: 5px;border-radius: 5px;width:200px; background-color: #171a1d; color: white; display: block; margin: auto; margin-top: 2%" href="{{ path('home') }}">Commander</a>
                            </div>
                        {% endfor %}

                    </div>

                </div>
            </div>
        </div>



    {% endfor %}




{% endblock %}



{% block javascripts %}
    {{ parent() }}
    <script src='https://api.mapbox.com/mapbox.js/v3.2.0/mapbox.js'></script>


    <script>

        var getParams = function (url) {
            var params = {};
            var parser = document.createElement('a');
            parser.href = url;
            var query = parser.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                params[pair[0]] = decodeURIComponent(pair[1]);
            }
            return params;
        };


        // Gestion des spectacles par théâtre
        function showDates(showId) {
            let currentShow = document.getElementsByClassName('currentShow');
            if (currentShow.length === 1) {
                currentShow[0].style.display = 'none';
                currentShow[0].classList.remove('currentShow');
            }

            let showElt = document.getElementById(showId);
            showElt.style.display = 'block';
            showElt.classList.add('currentShow');
        }

        // On initialise la latitude et la longitude de Lyon (centre de la carte)
        let lat = 45.75;
        let lon = 4.85;
        let zoom = 12; // Zoom de la carte par défaut

        L.mapbox.accessToken = 'pk.eyJ1IjoiYmFsaXNlcyIsImEiOiJjandqZThmaXIwZzF5NDhvNWE0eWhxbThjIn0.L-XJu_ElG2aGqQx4ZijbIg';
        let map = L.mapbox.map('map')
            .setView([lat, lon], zoom)
            .addLayer(L.mapbox.styleLayer('mapbox://styles/balises/cjwkvbvvf0b7i1cr4s3z4aqxk'));


        let customOptions =
            {
                'maxWidth': '100%',
                'width': '100%',
                'className' : 'popupCustom',
            };

        // Récupération coordonnées GPS dans tableau JS :
        let pointers =
            [
                {% for theater in theaters %}
                {
                    lat : '{{ theater.lat }}',
                    long : '{{ theater.longitude }}',
                    id : '{{ theater.id }}',
                },
                {% endfor %}
            ];


        for (let i = 0; i < pointers.length; i++)
        {
            let latitude = pointers[i].lat;
            let longitude = pointers[i].long;
            let pointerId = pointers[i].id;
            let elements = document.getElementById('theater'+ pointerId);
            let hideAction = document.getElementById('selectplacetitle');
            hideAction.style.display = "block";

            let marker = L.marker([latitude, longitude]).addTo(map);


            // Ouvrir bulle info lorsque clic sur marker
            marker.bindPopup(elements, customOptions);
            marker.addEventListener("click",function ()
            {
                elements.style.display = "block";
                hideAction.style.display = "none";
                map.setView([latitude, longitude]);

            });

            window.addEventListener("load", function()
            {
                let theaterIdForPointer = '{"theater":"theater' + pointerId + '"}'
                // console.log(JSON.stringify(getParams(window.location.href)))
                // console.log(theaterIdForPointer)


                if (JSON.stringify(getParams(window.location.href)) == theaterIdForPointer)
                {

                    map.setView([latitude, longitude], 16);
                }

            });
        }



        // Fermer bulle info quand clic sur map
        map.addEventListener("click", function ()
        {
            let hideAction = document.getElementById('selectplacetitle');
            hideAction.style.display = "block";
            map.setView([latitude, longitude]);
        });




        // Recentrer carte quand clique sur titre
        let clickontitle = document.getElementById('selectplacetitle');
        clickontitle.addEventListener("click", function()
        {
            map.setView([lat, lon], zoom);
        })


        // Info Text "Recentrer la carte"
        let maintitle = "SÉLECTIONNER<br>VOTRE <span>LIEU</span>";
        let secondTitle = "CENTRER<br>LA <span>CARTE</span>";
        clickontitle.addEventListener("mouseover", function()
        {
            this.children[0].style.visibility ="hidden";
            this.children[1].innerHTML = secondTitle;
        })
        clickontitle.addEventListener("mouseout", function()
        {
            this.children[0].style.visibility ="visible";
            this.children[1].innerHTML = maintitle;
        })

    </script>


{% endblock %}